# 소트머지조인 이어서
# 4.2.4 소트 머지 조인의 주용도

## vs 해시 조인

랜덤 액세스 위주의 NL 조인이 대량 데이터 처리에 한계를 보일 때 소트 머지 조인이 인기가 있었지만,

해시 조인의 등장으로 쓰임새가 예전만 못하다. (대부분 해시 조인이 더 빠름)

- 해시 조인 단점 
  - 조인 조건식이 등치(=) 조건이 아닐 때 사용할 수 없음
    > - 소트 머지 조인은 아래와 같은 상황에 주로 사용
    >   * 조인 조건식이 등치(=) 조건이 아닌 대량 데이터 조인
    >   * 조인 조건식이 아예 없는 조인(Cross Join, 카테시안 곱)
    >  > 조인 조건이 없어 두 집합에 대한 카테시안 곱을 만들 때 NL 조인을 사용한다고 가정. 
    >  > 
    >  > ➡️ 두 번째 읽히는 테이블(Inner Table)을 DB 버퍼 캐시에서 반복적으로 읽어야 함 -> 성능 좋지않음. 
    >  > 
    >  > ➡️ 한 번 읽어 PGA에 저장한 후 거기서 래치 획득 과정 없이 반복 스캔하는 것이 훨씬 좋음.


# 4.2.5 소트 머지 조인 제어하기

## 소트 머지 조인 실행 계획

```
Execution Plan

SELECT STATEMENT  Optimizer=ALL_ROWS
MERGE JOIN
  SORT (JOIN)
    TABLE ACCESS (BY INDEX ROWID) OF '사원' (TABLE)
    INDEX (RANGE SCAN) OF '사원_X1' (INDEX)
  SORT (JOIN)
    TABLE ACCESS (BY INDEX ROWID) OF 'ZZH' (TABLE)
    INDEX (RANGE SCAN) OF 'ZZH_X1' (INDEX)
```
- 해석
  - 양쪽 테이블을 각각 소트한 후,
  - 위쪽 사원 테이블 기준으로 아래쪽 고객 테이블과 머지 조인한다
  - 실행계획에서 소트할 대상을 찾기 위해 각 테이블을 액세스할 때 인덱스를 이용한다는 것을 알 수 있다.
    - (물론 인덱스를 이용하지 않고 Table Full Scan으로 처리할 수도 있다.)

## 소트 머지 조인 실행 계획을 제어

아래와 같이 `use_merge` 힌트를 사용한다.

```sql
SELECT /*+ ordered use_merge(c) */
       e.사원번호, e.사원명, e.입사일자,
       c.고객번호, c.고객명, c.전화번호, c.최종주문금액
FROM   사원 e, 고객 c
WHERE  c.관리사원번호 = e.사원번호
AND    e.입사일자 >= '19960101'
AND    e.부서코드 = 'Z123'
AND    c.최종주문금액 >= 20000;
```

- `ordered`: FROM 절에 기술한 순서대로 조인하라고 옵티마이저에 지시하는 힌트
  - `ordered` 대신 `leading(e)` 힌트 사용가능
- `use_merge`: 소트 머지 방식으로 조인하라고 지시하는 힌트
- `ordered`와 `use_merge(c)` 힌트를 같이 사용했으므로, 
  - 양쪽 테이블을 조인 컬럼 순으로 각각 정렬한 후 
  - ‘정렬된 사원’ 기준으로 ‘정렬된 고객’과 조인하라는 뜻으로 해석!

# 4.2.6 소트 머지 조인 특징 요약

- 조인을 위해 실시간 인덱스를 생성하는 것과 유사
- PGA 기반 조인으로 빠른 처리
  - 양쪽 집합을 정렬한 다음에는 NL 조인과 같은 방식으로 진행하지만, PGA 영역에 저장한 데이터를 이용해 빠름
    - 소트 부하만 감수한다면, 건건이 버퍼 캐시를 경유하는 NL 조인보다 빠름
- 인덱스 유무에 덜 의존적
  - NL 조인은 조인 컬럼에 대한 인덱스 유무에 크게 영향을 받지만, 소트 머지 조인은 영향을 받지 않는다.
  - 양쪽 집합을 개별적으로 읽고 나서 조인을 시작
    - 조인 컬럼에 인덱스가 없는 상황에서 두 테이블을 각각 읽어 조인 대상 집합을 줄일 수 있을 때 유리
- 스캔 기반 액세스
  - 기본적으로 스캔 위주의 액세스 방식(스캔 방식(Sequential Access))을 사용하지만,
  - 양쪽 소스 집합으로부터 조인 대상 레코드를 찾는 데 인덱스를 이용가능
    - 이 경우 랜덤 액세스 발생(해시 조인도 마찬가지)
