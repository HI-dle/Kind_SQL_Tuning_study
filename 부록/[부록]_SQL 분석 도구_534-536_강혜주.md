## 2 AUTO Trace

AutoTrace는 SQL 튜닝에 유용한 정보를 많이 포함하고 있어 튜너들이 가장 즐겨 사용하는 도구 중 하나다. 기본 사용법은 아래와 같다.

## 쿼리

```sql
SQL> set autotrace on
SQL> select * from scott.emp where empno = 7900;

EMPNO ENAME  JOB    MGR  HIREDATE             SAL COMM DEPTNO
----- ------ ------ ---- -------------------- --- ---- ------
7900  JAMES  CLERK  7698 81/12/03 00:00:00    950      30

1 개의 행이 선택되었습니다.      -- 쿼리 실행결과
```

## 예상 실행 계획
- 옵티마이저가 `이렇게 실행하겠다`라고 판단한 경로
- Rows, Cost: 통계기반 추정값.

```sql
Execution Plan

Plan hash value: 4024650034    

| Id | Operation                      | Name   | Rows | Bytes | Cost (%CPU) |
|----|--------------------------------|--------|------|-------|-------------|
|  0 | SELECT STATEMENT               |        | 1    | 32    | 1 (0)       |
|  1 | TABLE ACCESS BY INDEX ROWID    | EMP    | 1    | 32    | 1 (0)       |
|* 2 | INDEX UNIQUE SCAN              | PK_EMP | 1    |       | 0 (0)       |

Predicate Information (identified by operation id):

* 2 - access("EMPNO"=7900)
```
## 실행 통계
- 실제로 실행하면서 사용한 자원
```sql
Statistics                   
------------------------------------------
1  recursive calls -- SQL을 실행하면서 내부적으로 추가 실행된 SQL 횟수 (데이터 딕셔너리 조회, 권한, 메타데이터 조회 등)
0  db block gets -- current 모드로 읽은 블록 수
2  consistent gets -- 읽기 일관성(read consistency)을 위해 읽은 블록수, 논리적 I/O (인덱스블록, 테이블블록)
0  physical reads -- 디스크에서 읽은 블록수
0  redo size -- 리두로그 생성량(바이트), dml에서만 증가
743 bytes sent via SQL*Net to client -- 서버->클라이언트로 전송한 데이터량 (결과+메타정보)
374 bytes received via SQL*Net from client -- 클라이언트 -> 서버로 보낸 데이터 (sql)
1 SQL*Net roundtrips to/from client -- 네트워크 왕복 횟수
0 sorts (memory) 
0 sorts (disk)
1 rows processed --실제 처리 로우 수
```
---

옵션 조합에 따라 필요한 부분만 출력할 수 있다.

1. set autotrace on  
   SQL을 실행하고 결과집합과 함께 예상 실행계획 및 실행통계를 출력한다.

2. set autotrace on explain  
   SQL을 실행하고 결과집합과 함께 예상 실행계획을 출력한다.

3. set autotrace on statistics  
   SQL을 실행하고 결과집합과 함께 실행통계를 출력한다.

4. set autotrace traceonly  
   SQL을 실행하지만 결과는 출력하지 않고, 예상 실행계획과 실행통계만 출력한다.

5. set autotrace traceonly explain  
   SQL을 실행하지 않고, 예상 실행계획만 출력한다.

6. set autotrace traceonly statistics  
   SQL을 실행하지만 결과는 출력하지 않고, 실행통계만 출력한다.

- 1~3 은 실행결과를 출력해야 하므로 쿼리를 실제 수행한다.
- 4, 6은 실행통계를 보여줘야 하므로 쿼리를 실제 수행한다.
- 5는 예상 실행계획만 출력하면 되므로 쿼리를 실제 수행하지 않는다.
    - `SQL*Plus`에서 실행계획을 가장 쉽고 빠르게 확인해 볼 수 있는 방법
---

AutoTrace를 실행계획 확인 용도로만 사용한다면 plan table만 생성돼 있으면 된다.
하지만 실행통계까지 확인하려면 `v_$sesstat`, `v_$statname`, `v_$mystat` 뷰에 대한
읽기 권한이 필요하다. 따라서 dba, select_catalog_role 등의 롤을
부여받지 않은 일반 사용자에게는 별도의 권한 설정이 필요하다.

이들 뷰에 대한 읽기 권한을 일일이 부여해도 되지만,
plustrace 롤(Role)을 생성하고 필요한 사용자들에게 이 롤을 부여하면 편리하다.

```sql
SQL> @?/sqlplus/admin/plustrce.sql --grant 생성 스크립트
SQL> grant plustrace to scott;
```

토드나 오렌지 같은 상용 쿼리 툴에서도 실행통계를 확인할 수 있다.
토드에서는 우선 SQL 편집 창에서 마우스 오른쪽 버튼을 누르고
컨텍스트 메뉴에서 ‘Auto Trace’를 눌러 기능을 활성화한다.
그 상태에서 SQL을 실행하면 하단 ‘Auto Trace’ 탭에 실행통계가 출력된다.
오렌지에서는 상단 ‘Action’ 메뉴에서 ‘Extract Statistics’를 선택하거나
단축키 Ctrl+Shift+S를 누르면 바로 하단 ‘Statistics’ 탭에 실행통계가 출력된다.
