# SQL íŠ¸ë ˆì´ìŠ¤
---
## 1. SQL íŠ¸ë ˆì´ìŠ¤ ìˆ˜ì§‘ ë° íŒŒì¼ ì°¾ê¸°

SQLì„ íŠœë‹í•  ë•Œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ê°•ë ¥í•œ ë„êµ¬ëŠ” ë°”ë¡œ `SQL íŠ¸ë ˆì´ìŠ¤`ë‹¤.

ì•ì„œ ì‚´í´ ë³¸ `ì‚¬ì§„ ì‹¤í–‰ê³„íš`ê³¼ `AutoTrace` ê²°ê³¼ë§Œìœ¼ë¡œ ë¬¸ì œì ì„ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ SQL íŠ¸ë ˆì´ìŠ¤ë¥¼ ì´ìš©í•˜ë©´ ë¬¸ì œì ì„ ì‰½ê²Œ ì°¾ì•„ë‚¼ ìˆ˜ ìˆë‹¤.

### í˜„ì¬ ì ‘ì†í•´ ìˆëŠ” ì„¸ì…˜ì— íŠ¸ë ˆì´ìŠ¤ë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•
```sql
SQL> alter session set sql_trace = true; -- í˜„ì¬ ì„¸ì…˜ì˜ SQL íŠ¸ë ˆì´ìŠ¤ ì‹œì‘
SQL> select * from emp where empno = 7900; -- íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ì— ê¸°ë¡ë  ì˜ˆì •
SQL> select * from dual; -- íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ì— ê¸°ë¡ë  ì˜ˆì •
SQL> alter session set sql_trace = false; -- í˜„ì¬ ì„¸ì…˜ì˜ SQL íŠ¸ë ˆì´ìŠ¤ ì¢…ë£Œ
```

ìœ„ì™€ ê°™ì´ ì„¤ì •í•˜ê³  SQLì„ ì‹¤í–‰í•˜ë©´ ì•„ë˜ ì„œë²„ ë””ë ‰í† ë¦¬ì— íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ì´ ìƒì„±ëœë‹¤.

```sql
-- íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ì´ ìƒì„±ë˜ëŠ” ë””ë ‰í† ë¦¬ ì¡°íšŒ
SQL> select value
  2  from   v$diag_info -- diag(diagnostic: ì§„ë‹¨)
  3  where  name = 'Diag Trace' ;

VALUE -- ê²°ê³¼
------------------------------------------
/oracle/diag/rdbms/ora11g/trace
```

ì•„ë˜ ì¿¼ë¦¬ë¥¼ ì´ìš©í•˜ë©´ `íŒŒì¼ëª…`ê¹Œì§€ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
```sql
select value
from v$diag_info
where name = 'Default Trace File' ;

VALUE -- ê²°ê³¼
------------------------------------------
/oracle/diag/rdbms/ora11g/trace/ora11g_ora_22827.trc
```

(ì°¸ê³ ) ì˜¤ë¼í´ 10g ì´í•˜ ë²„ì „ì€ ë³µì¡í•œ ì¿¼ë¦¬ë¬¸ì„ í†µí•´ ì°¾ì„ ìˆ˜ ìˆë‹¤.
```sql
select r.value || '/' || lower(t.instance_name) || '_ora_'
        || trim(to_char(p.spid)) || '.trc' trace_file
from v$process p, v$session s, v$parameeter r, v$instance t
where p.addr = s.paddr
and r.name = 'user_dump_dest'
and s.sid = (select sid from v$mystat where rownum <= 1) ;

TRACE_FILE
--------------------------------------
/usr/local/oracle/admin/ORA10g/udump/ora10g_ora_22827.trc
```
---
## 2. ë¦¬í¬íŠ¸ ìƒì„±

íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ ë‚´ìš©ì€ ì‚¬ëŒì´ ê·¸ëŒ€ë¡œ ë¶„ì„í•˜ê¸°ê°€ ì‰½ì§€ ì•Šë‹¤.

ë”°ë¼ì„œ ì¼ë°˜ì ìœ¼ë¡œ `TKProf ìœ í‹¸ë¦¬í‹°`ë¥¼ ì‚¬ìš©í•œë‹¤. ( íŠ¸ë ˆì´ìŠ¤ ì»¤ë„ í”„ë¡œíŒŒì¼ )

- TKProfëŠ” íŠ¸ë ˆì´ìŠ¤ íŒŒì¼ì„ ë³´ê¸° ì‰½ê²Œ í¬ë©§íŒ…í•œ `ë¦¬í¬íŠ¸ë¥¼ ìƒì„±`í•´ì¤€ë‹¤.

### TKProf ìœ í‹¸ë¦¬í‹° ì‚¬ìš©ë²•
ì•„ë˜ì²˜ëŸ¼ ìœ ë‹‰ìŠ¤ ì‰˜ì´ë‚˜ ë„ìŠ¤ í”„ë¡¬í”„íŠ¸ì—ì„œ `tkprof`ë¥¼ ì¹˜ë©´ ì‚¬ìš©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```shell
$ tkprof
Usage: tkprof tracefile outputfile [explain= ] [table= ]
              [print= ] [insert= ] [sys= ] [sort= ]
......
```

### ì¼ë°˜ì ì¸ tkprof ì‚¬ìš©ë²•
```shell
- report.trc ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê² ë‹¤.
$ tkprof ora11g_ora_22827.trc report.prf sys=no

* sys=no ì˜µì…˜ì€ SQLì„ íŒŒì‹±í•˜ëŠ” ê³¼ì •ì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” SQLë¬¸ì„ ì œì™¸í•´ì¤€ë‹¤.
```

### ê²°ê³¼ í™•ì¸í•˜ê¸°
TKProfë¥¼ í†µí•´ ìƒì„±ëœ ë¦¬í¬íŠ¸ íŒŒì¼ì„ vi ì—ë””í„°ë‚˜ ìœˆë„ìš° ë…¸íŠ¸íŒ¨ë“œë¡œ ì—´ì–´ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ë©´ ëœë‹¤.
```shell
$ vi report.prf

*****************************************************************************
select *
from emp where empno = 7900

call    count        cpu   elapsed     disk      query     current     rows
-----------------------------------------------------------------------------
Parse       1        0.00     0.00        0           0          0        0
Execute     1        0.00     0.00        0           0          0        0
Fetch       2        0.00     0.00        0           2          0        1  # FetchëŠ” 'ë‹¤ìŒ í–‰ì´ ìˆëŠ” ì§€ ì§ˆë¬¸í•˜ëŠ” ê°œìˆ˜`ë¼ê³  ë³¼ ìˆ˜ ìˆëŠ” ë“¯ í•˜ë‹¤.
-----------------------------------------------------------------------------
total       4        0.00     0.00        0           2          0        1

Misses in library cache during parse: 1 # SQL íŒŒì‹± ì‹œ, ìºì‹œì—ì„œ ì°¾ì§€ ëª»í–ˆë‹¤.
Optimizer mode: ALL_ROWS
Parsing user id: 61 # userë¼ëŠ”ê±´ SYSê°€ ì•„ë‹Œ ì‚¬ìš©ìì˜ ì¿¼ë¦¬ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.

Rows  Rows Source Operation
------------------------------------------------------
   1  TABLE ACCESS BY INDEX ROWID EMP (cr=2 pr=0 pw=0 time=80 us)
   1    INDEX UNIQUE SCAN PK_EMP (cr=1 pr=0 pw=0 time=44 us)(object id 5278)
*****************************************************************************

```
---
## 3. íŠ¸ë ˆì´ìŠ¤ ê²°ê³¼ ë¶„ì„

> íŠ¸ë ˆì´ìŠ¤ ë‚´ìš©ì„ ë¶„ì„í•˜ëŠ” ì‘ì—…ì€ ì–´ë µë‹¤. ì•„ë§ˆ ì œëŒ€ë¡œ ë¶„ì„í•˜ë ¤ë©´ ì˜¤ë¼í´ ì„±ëŠ¥ ê³ ë„í™” ì›ë¦¬ì™€ í•´ë²•ì„ ëª¨ë‘ ë…íŒŒí•œ í›„ì—ë‚˜ ê°€ëŠ¥í• ì§€ ëª¨ë¥¸ë‹¤.

### ê° í•­ëª©ë³„ ì˜ë¯¸
- `call`: ì»¤ì„œì˜ ì§„í–‰ ìƒíƒœì— ë”°ë¼ Parse, Execute, Fetch ì„¸ ê°œì˜ Callë¡œ ë‚˜ëˆ„ì–´ ê°ê°ì— ëŒ€í•œ í†µê³„ì •ë³´ë¥¼ ë³´ì—¬ì¤€ë‹¤.
  - `Parse`: SQLì„ íŒŒì‹±í•˜ê³  ì‹¤í–‰ê³„íšì„ ìƒì„±í•˜ëŠ” ë‹¨ê³„
  - `Execute`: SQL ì»¤ì„œë¥¼ ì‹¤í–‰í•˜ëŠ” ë‹¨ê³„
  - `Fetch`: ë ˆì½”ë“œë¥¼ ì‹¤ì œë¡œ Fetch í•˜ëŠ” ë‹¨ê³„
- `count`: Parse, Execute, Fetch ê° ë‹¨ê³„ê°€ ìˆ˜í–‰ëœ íšŸìˆ˜
- `cpu`: í˜„ì¬ ì»¤ì„œê°€ ê° ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•œ cpu time
- `elapsed`: í˜„ì¬ ì»¤ì„œê°€ ê° ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë° ì†Œìš”ëœ ì‹œê°„
- `disk`: ë””ìŠ¤í¬ì—ì„œ ì½ì€ ë¸”ë¡ ìˆ˜
- `query`: Consistent ëª¨ë“œë¡œ ì½ì€ ë¸”ë¡ ìˆ˜
- `current`: Current ëª¨ë“œë¡œ ì½ì€ ë¸”ë¡ ìˆ˜
- `rows`: ê° ë‹¨ê³„ì—ì„œ ì½ê±°ë‚˜ ê°±ì‹ í•œ ê±´ìˆ˜

> **ğŸš€ Misses in library cache during parse: 1 ì„ í†µí•œ ë³µìŠµ**
> 
> ìœ„ì—ì„œ í–ˆë‹¤ì‹œí”¼ SQL íŒŒì‹± ì‹œì ì— library cacheì— ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»¤ì„œë¥¼ ì°¾ì§€ ëª»í•´ì„œ í•˜ë“œ íŒŒì‹±ì´ 1ë²ˆ ë°œìƒí–ˆìŒì„ ì˜ë¯¸í•œë‹¤.
> 
> ë ë¦¬ì„œ ì•„ë˜ ì¿¼ë¦¬ë¥¼ í•œ ë²ˆ ë” ë•Œë¦¬ë©´,
>
> ```sql
> select *
> from emp where empno = 7900
> ```
> 
> ë‹¤ìŒì—” ìºì‹œì—ì„œ ì´ë¯¸ íŒŒì‹±ëœ SQL, ì‹¤í–‰ê³„íš ë“±ì„ ë¹ ë¥´ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤!
> 
> ê·¼ë° `empno = 7900` ì´ ì•„ë‹Œ, `7901, 7902 ...` ì²˜ëŸ¼ SQL í…ìŠ¤íŠ¸ê°€ ë³€ê²½ë¼ì„œ ë“¤ì–´ì˜¨ë‹¤ë©´? ë§¤ë²ˆ í•˜ë“œ íŒŒì‹±ì´ ì¼ì–´ë‚œë‹¤.
> 
> ì´ ê²½ìš° `ë°”ì¸ë“œ ë³€ìˆ˜`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ SQL í…ìŠ¤íŠ¸ê°€ ë™ì¼í•´ì ¸ í•˜ë“œ íŒŒì‹±ì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.
> 
> ```sql
> select * from emp where empno = :empno;
> ```

ë…¼ë¦¬ì  I/OëŠ” `query`ì™€ `current` í•­ëª©ì„ ë”í•´ì„œ êµ¬í•œë‹¤. ì´ëŠ” DB ë²„í¼ìºì‹œë¥¼ ê²½ìœ í•´ì„œ ì½ì€ ë¸”ë¡ê³¼ Direct Path I/O ë°©ì‹ìœ¼ë¡œ ì½ì€ ë¸”ë¡ ëª¨ë‘ í¬í•¨í•œë‹¤.

2ì ˆì—ì„œ ì‚´í´ë³¸ `AutoTrace`ì™€ ì¼ì¹˜í•˜ëŠ” í•­ëª©ì„ ë§¤í•‘í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

| SQL íŠ¸ë ˆì´ìŠ¤    | AutoTrace                              | ì„¤ëª…                                     |
|-------------|----------------------------------------|----------------------------------------|
| current     | db block gets                          | Current ëª¨ë“œë¡œ ì½ì€ ë¸”ë¡ ìˆ˜                    |
| query       | consistent gets                        | Consistent ëª¨ë“œë¡œ ì½ì€ ë¸”ë¡ ìˆ˜                 |
| disk        | physical reads                         | ë””ìŠ¤í¬ì—ì„œ ì½ì€ ë¸”ë¡ ìˆ˜                          |
| fetch count | SQL *Net roundtrips<br/>to/from client | ì¡°íšŒ ê²°ê³¼ë¥¼ ì „ì†¡ì„ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ê°€ ë°œí–‰í•œ Fetch Call íšŸìˆ˜ |
| fetch rows  | rows processed                         | ì¡°íšŒ ê±´ìˆ˜                                  |

### Call í†µê³„ ì•„ë˜ìª½ ì‹¤í–‰ê³„íš í†µê³„(Plan Statistics)ì— ë‚˜íƒ€ë‚˜ëŠ” ê° í•­ëª©ì˜ ì˜ë¯¸

```sql
Rows  Rows Source Operation
------------------------------------------------------
   1  TABLE ACCESS BY INDEX ROWID EMP (cr=2 pr=0 pw=0 time=80 us)
   1    INDEX UNIQUE SCAN PK_EMP (cr=1 pr=0 pw=0 time=44 us)(object id 5278)
```

`Rows`: ê° ìˆ˜í–‰ ë‹¨ê³„ì—ì„œ ì¶œë ¥ëœ ë¡œìš° ìˆ˜
  - (ì˜¤ë¼í´ ë²„ì „ 7ê¹Œì§€ëŠ” ê° ë‹¨ê³„ì—ì„œì˜ `ì²˜ë¦¬ ê±´ìˆ˜`ë¥¼ ë³´ì—¬ì£¼ë‹¤ê°€ 8ië¶€í„° `ì¶œë ¥ ê±´ìˆ˜`ë¡œ ë°”ë€Œê¸° ì‹œì‘í–ˆë‹¤.)

> â“ ì²˜ë¦¬ ê±´ìˆ˜ì™€ ì¶œë ¥ ê±´ìˆ˜ë€?
> 
> ì²˜ë¦¬ ê±´ìˆ˜ëŠ” ë§ê·¸ëŒ€ë¡œ í•´ë‹¹ ì‹¤í–‰ ë‹¨ê³„ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ë‹¤ë£¬ ë¡œìš° ìˆ˜
> 
> ì¶œë ¥ ê±´ìˆ˜ëŠ” ë‹¤ìŒ ì‹¤í–‰ ë‹¨ê³„ë¡œ ì‹¤ì œ ì „ë‹¬ëœ ë¡œìš° ìˆ˜. ì¦‰, ê²°ê³¼ ê±´ìˆ˜ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.
> 
> ```sql
> -- EMP í…Œì´ë¸”ì— 10000ê±´, ì¡°ê±´ ë§Œì¡± 100ê±´ ì´ë¼ë©´?
> SELECT * FROM emp WHERE sal > 3000;
> 
> -- ì²˜ë¦¬ê±´ìˆ˜ = 10000
> -- ì¶œë ¥ê±´ìˆ˜ = 100
> ```

`(cr, pr, pw, time)`: ì˜¤ë¼í´ì€ ì¶œë ¥(Flow-Out) ë°©ì‹ìœ¼ë¡œ ë°”ë€Œë©´ì„œ ìƒê¸´ `ë‹¨ì ì„ ë³´ì™„í•˜ë ¤ê³  ì´ë¥¼ í‘œí˜„`í•˜ê¸° ì‹œì‘
  - ê°ê° `Consistent ëª¨ë“œ ë¸”ë¡ ì½ê¸°`, `ë””ìŠ¤í¬ ë¸”ë¡ ì½ê¸°`, `ë””ìŠ¤í¬ ë¸”ë¡ ì“°ê¸°`, `ì†Œìš” ì‹œê°„`ì„ ì˜ë¯¸
  - ë‹¨ì ì´ë€, ì¶œë ¥ ë°©ì‹(ê²°ê³¼ ê±´ìˆ˜ë§Œ ë³´ì—¬ì£¼ëŠ”)ìœ¼ë¡œ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ì‹¤ì œ ì‘ì—…ëŸ‰ì´ ë³´ì´ì§€ ì•ŠìŒ. ì´ë¥¼ ì§€í‘œë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•¨.

> ê¼­ ê¸°ì–µí•´ì•¼í•  ê²ƒ!
> 
> ë¶€ëª¨ë“  ìì‹ë…¸ë“œì˜ ê°’ì„ í¬í•¨í•œë‹¤ëŠ” ì‚¬ì‹¤.
> 
> ```sql
> -- í…Œì´ë¸” ì—‘ì„¸ìŠ¤ ë‹¨ê³„ì˜ cr=2ë‹¤.
> 1  TABLE ACCESS BY INDEX ROWID EMP (cr=2 pr=0 pw=0 time=80 us)
> ```
> 
> ```sql
> -- PK_EMP ì¸ë±ìŠ¤ ë‹¨ê³„ëŠ” cr=1ì´ë‹¤.
> 1    INDEX UNIQUE SCAN PK_EMP (cr=1 pr=0 pw=0 time=44 us)(object id 5278)
> 
> -- ì¦‰, ì¸ë±ìŠ¤ë¥¼ ì½ê³  ë‚œ í›„ í…Œì´ë¸”ì„ ì•¡ì„¸ìŠ¤í•˜ëŠ” ë‹¨ê³„ì˜ ìˆœìˆ˜ cr ê°œìˆ˜(Consistent ëª¨ë“œ ë¸”ë¡ ì½ê¸° ê°œìˆ˜)ëŠ” 1ì´ë‹¤.
> ```