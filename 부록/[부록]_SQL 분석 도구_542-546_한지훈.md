# SQL 분석 도구

--- 

## 4 DBMS_XPLAN 패키지

- 오라클 9.2 버전에 소개된 dbms_xplan 패키지를 이용하면 plan_table에 저장된 실행계획을 좀더 쉽게 출력해 볼 수 있게 되었따.
- 오라클 10g부터는 이 패키지로 라이브러리 캐시에 캐싱된 SQL 실행계획도 확인할 수 있고 심지어 SQL 트레이스처럼 오퍼레이션 단계별 수행 통계도 손쉽게 확인할 수 있다.


### 예상 실행계획 출력

- 앞에서 @?/rdbms/admin/utlxpls 스크립트를 사용해 실행계획을 출력하는 방법을 보았는데, 그 스크립트를 열어보면 dbms_xplan 패키지를 사용하는 것을 확인할 수 있다.


```oracle-sql
select plan_table_output
from table (dbms_xplan.display('plan_table', null, 'serial'));
```

- 첫 번째 인자에는 실행계획이 저장된 plan table명을 입력하고 두 번째 인자에는 statement_id를 입력하면 된다. 두 번째 인자가 null이면 가장 마지막 explain plan 명령에 사용했던 쿼리 실행계획을 보여준다.
- 세번째 인자를 통해 다양한 포맷 옵션을 지정할 수 있는데 우선 basic 옵션을 지정해보면 ID, operation, name 컬럼만 출력한다.

```oracle-sql
explain plan set statement_id = 'SQL1' for
select *
from emp e, dept d
where d.deptno = e.deptno
and e.sal >= 1000;
```


- format 인자를 구사하면 rows, bytes, cost 컬럼까지 출력한다.

```oracle-sql
select * from table (dbms_xplan.display('PLAN_TABLE', 'SQL1', 'BASIC'));
```


- 그 외 추가로 사용할 수 있는 옵션은 다음과 같다.
  - TYPICAL
  - SERIAL
  - PARTITION
  - PARALLEL
  - PREDICATE
  - PROJECTION
  - ALIAS
  - REMOTE
  - NOTE
  - ALL
  - OUTLINE
  - ADVANCED

### 캐싱된 커서의 실제 실행계획 출력

- SQL 커서란 하드 파싱 과정을 거쳐 메모리에 적재된 SQL과 파싱트리, 실행계획 그리고 SQL을 실행하는 데 필요한 정보를 담은 SQL area를 말한다.
- 오라클은 라이브러리 캐시에 캐싱된 각 커서에 대한 수행통계를 볼 수 있도록 v$sql 뷰를 제공한다.
- 실행계획은 v$sql_plan 뷰에서 확인할 수 있다. v$sql_plan을 조회하려면 SQL에 대한 sql_id와 child_number 값을 알아야 하는 직전에 수행한 SQL에 대한 sql_id와 child_number를 출력해주는 쿼리를 확인해보자.


```oracle-sql
select prev_sql_id as sql_id, prev_child_number as child_no
from v$session
where sid = userenv('sid')
and username is not null
and prev_hash_value <> 0;
```

- 더 이전에 수행한 SQL을 찾으려면 SQL 텍스트로 검색해야 한다.

```oracle-sql
select sql_id, child_number, sql_fulltext, last_active_time
from v$sql
where sql_text like '%select/* comment */%from%emp%dept%'
```


 - 찾은 sql_id와 child_number로 v$sql_plan 뷰를 직접 조회할 수 있지만 dbms_xplan.display_cursor 함수를 이용하면 편하다.
 - 첫 번째, 두 번째 인자에 sql_id와 child_number를 입력하고 실행하면 된다 세 번째 format 인자에는 앞에서 dbms_xplan.display 함수에 사용했던 옵션들을 그대로 사용한다.


````oracle-sql
select * from table (dbms_xplan.display_cursor('[sql_id]', [child_no],'[format]'));
````

- sql_id와 child_number를 매번 찾는게 귀찮다면 null을 입력해도 된다. 그러면 바로 직전에 수행한 SQL 정보를 보여준다.


```oracle-sql
select * from table (dbms_xplan.display_cursor(null , null ,'BASIC ROWS BYTES COST PREDICATE'));
```


- 위 명령어가 잘 실행되지 않는다면 v$session, v$sql, v$sql_plan 뷰에 대한 조회 권한이 없이 때문이기에 해당 뷰에 대한 권한을 넣어주면 된다.
- 만약 SQL Plus에서 dbms_xplan.display_cursor 함수를 실행하면서 sql_id와 child_number 인자에 null을 입력하고 싶다면 serveroutput을 off 상태로 전환해야 한다.

```oracle-sql
SQL> set serveroutput off;
SQL> select * from emp;
SQL> select * from table (dbms_xplan.display_cursor(null , null ,'serial'));
```